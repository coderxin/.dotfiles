# True color support (critical for Ghostty + Tokyo Night theme)
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -ga terminal-overrides ",ghostty:Tc"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

set -g prefix C-a

bind-key C-a send-prefix

bind c new-window -c "#{pane_current_path}"

unbind %
bind | split-window -h -c "#{pane_current_path}"

unbind '"'
bind - split-window -v -c "#{pane_current_path}"

unbind r
bind r source-file ~/.tmux.conf \; display "Configuration reloaded!"

# Edit config
bind e new-window -n "tmux.conf" "nvim ~/.tmux.conf"

bind -r j resize-pane -D 5
bind -r k resize-pane -U 5
bind -r l resize-pane -R 5
bind -r h resize-pane -L 5

bind -r m resize-pane -Z

# Fine-grained resizing
bind -r H resize-pane -L 2
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2
bind -r L resize-pane -R 2

# Window Management
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+
bind -r "<" swap-window -d -t -1
bind -r ">" swap-window -d -t +1

# Rename
bind R command-prompt -I "#S" "rename-session '%%'"

# Kill without confirmation
bind x kill-pane
bind X kill-window
bind Q confirm-before -p "Kill session #S? (y/n)" kill-session

# Pane operations
bind b break-pane -d
bind j choose-window 'join-pane -h -s "%%"'
bind J choose-window 'join-pane -s "%%"'
bind -r "{" swap-pane -U
bind -r "}" swap-pane -D
bind S set-window-option synchronize-panes\; display-message "Panes sync: #{?pane_synchronized,ON,OFF}"
bind M select-pane -m

# Session Management
bind C-j choose-tree -Zs
bind Space switch-client -l
bind N command-prompt -p "New session name:" "new-session -s '%%'"
bind w choose-tree -Zw -O name
bind D detach-client -a
bind s display-popup -E -w 60% -h 60% "tmux list-sessions -F '#{session_name}' | fzf --reverse --prompt='Switch to session: ' | xargs tmux switch-client -t"

set -g mouse on

set-window-option -g mode-keys vi

# Copy Mode (Vi)
bind Enter copy-mode
bind P paste-buffer

set -g set-clipboard off
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi 'C-v' send-keys -X rectangle-toggle
bind-key -T copy-mode-vi 'Escape' send-keys -X cancel

# Quick search
bind / copy-mode \; send-key ?

# Tool Integration
bind g display-popup -E -w 90% -h 90% "lazygit"
bind G display-popup -E -w 90% -h 90% "tig"
bind C-g split-window -h -c "#{pane_current_path}" "git status && bash"
bind k display-popup -E -w 95% -h 95% "k9s"
bind K display-popup -E -w 60% -h 40% "kubectl config get-contexts | fzf --header-lines=1 | awk '{print \$1}' | xargs -I {} kubectl config use-context {}"


# fix for neovim: escape-time
# https://github.com/neovim/neovim/wiki/FAQ#esc-in-tmux-or-gnu-screen-is-delayed
set-option -sg escape-time 10

# Performance optimizations
set -g history-limit 50000          # Increased scrollback buffer
set -g display-time 2000            # Message display time
set -g status-interval 5            # Status bar update frequency
set -g focus-events on              # Focus events for terminal-vim
setw -g aggressive-resize on        # Aggressive window resizing

# Indexing
set -g base-index 1                 # Start windows at 1, not 0
setw -g pane-base-index 1           # Start panes at 1, not 0
set -g renumber-windows on          # Renumber windows when one is closed

# ============================================
# STATUS BAR
# ============================================

set -g status-position bottom
set -g status-justify left
set -g status-style 'bg=colour234 fg=colour247'
set -g status-left-length 100
set -g status-right-length 150

# Left: session, git branch, window:pane
set -g status-left "#[fg=black,bg=cyan,bold] #S #[fg=cyan,bg=colour236,nobold]#[fg=white,bg=colour236] #(cd #{pane_current_path}; git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'no git') #[fg=colour236,bg=colour234]#[fg=colour247,bg=colour234] #I:#P "

# Right: k8s context, cpu, ram, battery, time
set -g status-right "#[fg=colour234,bg=colour234]#[fg=colour208,bg=colour234] #(~/.bin/tmux-kube-context) #[fg=white] CPU: #{cpu_fg_color}#{cpu_percentage}#[fg=white] RAM: #{ram_fg_color}#{ram_percentage}#[default] #[fg=colour236,bg=colour234]#[fg=white,bg=colour236] #{battery_icon} #{battery_percentage} #[fg=cyan,bg=colour236]#[fg=black,bg=cyan,bold] %H:%M %d-%b "

# Window status
setw -g window-status-current-style 'fg=black bg=cyan bold'
setw -g window-status-current-format ' #I:#W#F '
setw -g window-status-style 'fg=colour247 bg=colour236'
setw -g window-status-format ' #I:#W#F '
setw -g window-status-bell-style 'fg=colour255 bg=colour1 bold'

# Pane borders
set -g pane-border-style 'fg=colour236'
set -g pane-active-border-style 'fg=cyan'

# Message styling
set -g message-style 'fg=black bg=cyan bold'
set -g message-command-style 'fg=black bg=cyan'

# Activity
set -g visual-activity off
set -g visual-bell off
set -g monitor-activity on

# ============================================
# PLUGINS
# ============================================

# tpm plugin
set -g @plugin 'tmux-plugins/tpm'

# Core plugins
set -g @plugin 'christoomey/vim-tmux-navigator'  # Seamless vim/tmux navigation
set -g @plugin 'tmux-plugins/tmux-sensible'      # Sensible defaults
set -g @plugin 'tmux-plugins/tmux-yank'          # Enhanced clipboard
set -g @plugin 'tmux-plugins/tmux-open'          # Open URLs/files
set -g @plugin 'laktak/extrakto'                 # Fuzzy text extraction

# Session management
set -g @plugin 'tmux-plugins/tmux-resurrect'     # Persist sessions
set -g @plugin 'tmux-plugins/tmux-continuum'     # Auto-save sessions

# Status bar plugins
set -g @plugin 'tmux-plugins/tmux-cpu'           # CPU/RAM metrics
set -g @plugin 'tmux-plugins/tmux-battery'       # Battery status

# ============================================
# PLUGIN CONFIGURATION
# ============================================

# CPU plugin
set -g @cpu_low_fg_color "#[fg=green]"
set -g @cpu_medium_fg_color "#[fg=yellow]"
set -g @cpu_high_fg_color "#[fg=red]"
set -g @cpu_low_thresh 30
set -g @cpu_medium_thresh 70
set -g @cpu_percentage_format "%3.0f%%"

# RAM plugin
set -g @ram_low_fg_color "#[fg=green]"
set -g @ram_medium_fg_color "#[fg=yellow]"
set -g @ram_high_fg_color "#[fg=red]"
set -g @ram_low_thresh 30
set -g @ram_medium_thresh 70
set -g @ram_percentage_format "%3.0f%%"

# Battery plugin
set -g @batt_icon_charge_tier8 '‚ñà'
set -g @batt_icon_charge_tier7 '‚ñá'
set -g @batt_icon_charge_tier6 '‚ñÜ'
set -g @batt_icon_charge_tier5 '‚ñÖ'
set -g @batt_icon_charge_tier4 '‚ñÑ'
set -g @batt_icon_charge_tier3 '‚ñÉ'
set -g @batt_icon_charge_tier2 '‚ñÇ'
set -g @batt_icon_charge_tier1 '‚ñÅ'
set -g @batt_icon_status_charged 'üîã'
set -g @batt_icon_status_charging '‚ö°'
set -g @batt_icon_status_discharging 'üîã'

# Resurrect plugin
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-processes 'ssh psql mysql lazygit tig k9s glances htop "~cargo watch" "~npm run dev"'

# Continuum plugin
set -g @continuum-restore 'on'
set -g @continuum-boot 'on'
set -g @continuum-boot-options 'ghostty'
set -g @continuum-save-interval '15'

# Yank plugin
set -g @yank_selection 'clipboard'
set -g @yank_selection_mouse 'clipboard'
set -g @yank_with_mouse on

# Extrakto plugin
set -g @extrakto_split_direction 'v'
set -g @extrakto_split_size '15'
set -g @extrakto_grab_area 'full'
set -g @extrakto_fzf_tool 'fzf'

# Initialize TMUX plugin manager
run '~/.tmux/plugins/tpm/tpm'

